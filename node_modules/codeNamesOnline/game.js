'use strict';

//==============================================================================
//  Modules
//==============================================================================

var socketManager = require('codeNamesOnline/socketManager');
var wordType      = require('codeNamesOnline/constants/wordType');

//==============================================================================
//  Exports
//==============================================================================

module.exports = function (gameCode, wordGrid, startTeam, socketId) {
	var self                = this;
	var gameCode            = gameCode;
	var wordGrid            = wordGrid;
	var socketId            = socketId;
	var turn                = startTeam;
	var gameStatus          = null;
	var gameEnd             = false;
	var blueTeamWordsLeft   = null;
	var redTeamWordsLeft    = null;
	var blueTeamChosenWords = [];
	var redTeamChosenWords  = [];
	var blueTeamCodeMaster  = null;
	var redTeamCodeMaster   = null;

	// Init

	if (startTeam === 'blue') {
		blueTeamWordsLeft = 9;
		redTeamWordsLeft = 8;
		gameStatus = 'Blue Teams turn';
	}
	else {
		blueTeamWordsLeft = 8;
		redTeamWordsLeft = 9;
		gameStatus = 'Red Teams turn';
	}

	// Getters

	this.getGameCode = function () {
		return gameCode;
	};

	// Setters

	this.setBlueTeamCodeMaster = function (codeMaster) {
		if (blueTeamCodeMaster !== null) {
			throw new Error('This game already has a Code Master for Blue Team');
		}
		blueTeamCodeMaster = codeMaster;
		AddPlayer(blueTeamCodeMaster);
	};

	this.setRedTeamCodeMaster = function (codeMaster) {
		if (redTeamCodeMaster !== null) {
			throw new Error('This game already has a Code Master for Red Team');
		}
		redTeamCodeMaster = codeMaster;
		AddPlayer(redTeamCodeMaster);
	};

	this.removeBlueTeamCodeMaster = function () {
		blueTeamCodeMaster = null;
	};

	this.removeRedTeamCodeMaster = function () {
		redTeamCodeMaster = null;
	};

	// Public functions

	this.getGameData = function () {
		return {
			wordGrid            : wordGrid,
			blueTeamWordsLeft   : blueTeamWordsLeft,
			redTeamWordsLeft    : redTeamWordsLeft,
			blueTeamChosenWords : blueTeamChosenWords,
			redTeamChosenWords  : redTeamChosenWords,
			turn                : turn,
			gameStatus          : gameStatus,
			gameEnd             : gameEnd
		};
	};

	this.selectWord = function (word) {
		for (var x = 0; x < 5; x++) {
			for (var y = 0; y < 5; y++) {
				if (wordGrid[x][y].word === word && wordGrid[x][y].chosen === false) {
					wordGrid[x][y].chosen = true;
					if (wordGrid[x][y].type === wordType.BLUE_TEAM) {
						blueTeamWordsLeft--;
						blueTeamChosenWords.push(word);
						if (turn === 'red') {
							self.nextTurn();
						}
						if (blueTeamWordsLeft === 0) {
							self.EndGame('blue');
						}
					}
					else if (wordGrid[x][y].type === wordType.RED_TEAM) {
						redTeamWordsLeft--;
						redTeamChosenWords.push(word);
						if (turn === 'blue') {
							self.nextTurn();
						}
						if (redTeamWordsLeft === 0) {
							self.EndGame('red');
						}
					}
					else if (wordGrid[x][y].type === wordType.NO_TEAM) {
						self.nextTurn();
					}
					else if (wordGrid[x][y].type === wordType.KILL_WORD) {
						if (turn === 'blue') {
							self.EndGame('red');
						}
						else {
							self.EndGame('blue');
						}
					}
				}
			}
		}
		UpdateGame();
	};

	this.nextTurn = function () {
		if (turn === 'blue') {
			turn = 'red';
			gameStatus = 'Red Teams turn';
		}
		else {
			turn = 'blue';
			gameStatus = 'Blue Teams turn';
		}
		UpdateGame();
	};

	this.EndGame = function (winningTeam) {
		if (winningTeam === 'blue') {
			gameStatus = 'Blue Team wins!';
		}
		else if (winningTeam === 'red') {
			gameStatus = 'Red Team wins!';
		}
		else {
			gameStatus = 'Game abruptly ended';
		}
		gameEnd = true;
		UpdateGame();
	};

	this.resetGame = function (newWordGrid, startTeam) {
		wordGrid            = newWordGrid;
		turn                = startTeam;
		gameStatus          = null;
		gameEnd             = false;
		blueTeamWordsLeft   = null;
		redTeamWordsLeft    = null;
		blueTeamChosenWords = [];
		redTeamChosenWords  = [];

		if (startTeam === 'blue') {
			blueTeamWordsLeft = 9;
			redTeamWordsLeft = 8;
			gameStatus = 'Blue Teams turn';
		}
		else {
			blueTeamWordsLeft = 8;
			redTeamWordsLeft = 9;
			gameStatus = 'Red Teams turn';
		}
		UpdateGame();
	};

	// Private functions

	function UpdateGame () {
		var gameSocket = socketManager.GetSocket(socketId);
		var blueCodeMasterSocket = socketManager.GetSocket(blueTeamCodeMaster.getSocketId());
		var redCodeMasterSocket = socketManager.GetSocket(redTeamCodeMaster.getSocketId());
		if (gameSocket) {
			gameSocket.emit('updateGameData', self.getGameData());
		}
		else {
			console.log('Unable to update game! No socket');
		}
		if (blueCodeMasterSocket) {
			blueCodeMasterSocket.emit('updateGameData', self.getGameData());
		}
		else {
			console.log('Unable to update game! (Blue Team) No socket');
		}
		if (redCodeMasterSocket) {
			redCodeMasterSocket.emit('updateGameData', self.getGameData());
		}
		else {
			console.log('Unable to update game! (Red Team) No socket');
		}
	}

	// Tell the frontend that a player has been added
	function AddPlayer (player) {
		var gameSocket = socketManager.GetSocket(socketId);
		gameSocket.emit('playerConnect', {
			name : player.getName(),
			team : player.getTeam()
		});
	}

};

